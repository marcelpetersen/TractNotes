<!doctype html><html>  <head>    <meta charset="utf-8">    <base href="../">    <title>JSDoc: source : track.view.controller.js</title>    <link type="text/css" rel="stylesheet" href="css/jsdoc-default.css">    <link href="css/prettify-tomorrow.css" type="text/css" rel="stylesheet">    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,400,300,700" rel="stylesheet" type="text/css">    <link href="css/custom.css" type="text/css" rel="stylesheet">    <script src="js/prettify.js"></script>    <script src="js/angular.min.js"></script>  </head>  <body ng-app="">    <nav>      <h2><a href="index.html">Index</a></h2>      <ul class="module">        <!-- _ract_otes -->        <h3>          <a href="" ng-click="module_ract_otes = !module_ract_otes">            module: TractNotes          </a>          <i ng-cloak="" ng-show="module_ract_otes">+</i>        </h3>        <li id="TractNotes" ng-hide="module_ract_otes">          <ul class="group">            <h3>              <a href="" ng-click="_ract_otesfactory = !_ract_otesfactory">                factory              </a>              <i ng-cloak="" ng-show="_ract_otesfactory">+</i>            </h3>            <ul ng-hide="_ract_otesfactory">              <li>                <a href="TractNotes.drawnItemsService.html">drawnItemsService</a>              </li><li>                <a href="TractNotes.googleApi.html">googleApi</a>              </li><li>                <a href="TractNotes.importService.html">importService</a>              </li><li>                <a href="TractNotes.layerControlService.html">layerControlService</a>              </li><li>                <a href="TractNotes.locationService.html">locationService</a>              </li><li>                <a href="TractNotes.settingsService.html">settingsService</a>              </li><li>                <a href="TractNotes.trackService.html">trackService</a>              </li><li>                <a href="TractNotes.trackViewService.html">trackViewService</a>              </li>            </ul>          </ul><ul class="group">            <h3>              <a href="" ng-click="_ract_otesservice = !_ract_otesservice">                service              </a>              <i ng-cloak="" ng-show="_ract_otesservice">+</i>            </h3>            <ul ng-hide="_ract_otesservice">              <li>                <a href="TractNotes.Drive.html">Drive</a>              </li>            </ul>          </ul><ul class="group">            <h3>              <a href="" ng-click="_ract_otescontroller = !_ract_otescontroller">                controller              </a>              <i ng-cloak="" ng-show="_ract_otescontroller">+</i>            </h3>            <ul ng-hide="_ract_otescontroller">              <li>                <a href="TractNotes.DriveController.html">DriveController</a>              </li><li>                <a href="TractNotes.FormController.html">FormController</a>              </li><li>                <a href="TractNotes.MapController.html">MapController</a>              </li><li>                <a href="TractNotes.TrackController.html">TrackController</a>              </li><li>                <a href="TractNotes.TrackViewController.html">TrackViewController</a>              </li>            </ul>          </ul><ul class="group">            <h3>              <a href="" ng-click="_ract_otesmodule = !_ract_otesmodule">                module              </a>              <i ng-cloak="" ng-show="_ract_otesmodule">+</i>            </h3>            <ul ng-hide="_ract_otesmodule">              <li>                <a href="TractNotes.TractNotesApp.html">TractNotesApp</a>              </li>            </ul>          </ul>        </li>      </ul>    </nav>    <div id="content" class="page-wrap">      <h1 class="title">        source : track.view.controller.js      </h1>      <div id="main" class="big-container">        <!-- source code html -->        <article>          <pre class="prettyprint source linenums"><code>(function() {    'use strict';    /**     * @memberof TractNotes     * @ngdoc controller     * @name TrackViewController     * @param {service} $scope Application model in AngularJS     * @param {service} $rootScope Root application model in AngularJS     * @param {service} trackService Track creation factory     * @param {service} trackViewService Track view rendering factory     * @param {service} $ionicHistory State history service in Ionic     * @param {service} Drive Drive API service     * @param {service} $state State service in Angular UI Router     * @property {object} vm ViewModel capture variable for *this*.     * @desc This controller manages individual track views.     */    angular        .module('TractNotes')        .controller('TrackViewController', TrackViewController);    TrackViewController.$inject = ['$scope', '$rootScope', 'trackService', 'trackViewService', '$ionicHistory', 'Drive', '$state'];    /* @ngInject */    function TrackViewController($scope, $rootScope, trackService, trackViewService, $ionicHistory, Drive, $state) {        var vm = this;        vm.title = 'TrackViewController';        vm.currentTrack = null;        vm.input = {};        vm.back = back;        vm.updateMetadata = updateMetadata;        vm.exportTrack = exportTrack;        vm.uploadToDrive = uploadToDrive;        vm.exportTrackToDevice = exportTrackToDevice;        vm.discardChanges = discardChanges;        activate();        ////////////////        /**         * Initialize currentTrack to view to be rendered from trackViewService         * @memberof TrackViewController         * @function activate         */        function activate() {            vm.currentTrack = trackViewService.getTrackView();            if (vm.currentTrack) {                vm.input = angular.copy(vm.currentTrack.metadata);            }        }        /**         * Ensures the user is logged in and calls uploadToDrive.         * @memberof TrackViewController         * @function exportTrack         */        function exportTrack() {            var auth_token = gapi.auth.getToken();            if (auth_token) {                uploadToDrive();            } else {                Drive.authenticate()                    .then(function(response) { //authenticate                            if (response) {                                gapi.auth.setToken(response);                                uploadToDrive();                            }                        },                        function(error) {                            console.log("" + error);                        });            }        }        /**         * Generates GPX and KML files from toExport and uploads them to Google Drive in the TractNotes folder.         * @memberof TrackViewController         * @function uploadToDrive         */        function uploadToDrive() {            var toExport = {                "type": "FeatureCollection",                "features": []            }            toExport.features.push(vm.currentTrack.polyline.toGeoJSON());            for (var i = 0; i &lt; vm.currentTrack.markers.length; i++) {                toExport.features.push(vm.currentTrack.markers[i].toGeoJSON());            }            var gpx = togpx(toExport, {                metadata: vm.currentTrack.metadata            });            var kml = tokml(toExport);            console.log("GPX file:");            console.log(gpx);            console.log("KML file:");            console.log(kml);            //Ensure TractNotes Folder exists or create one            Drive.tractNotesFolder().then(function(tractNotesID) {                //Make Folder for Track                Drive.trackFolder(vm.currentTrack.metadata.name, tractNotesID).then(function(folderID) {                    console.log("Track Folder: success.");                    /** Export GPX */                    var name = vm.currentTrack.metadata.name + ".gpx";                    var metadata = {                        'title': name,                        'mimeType': 'application/gpx+xml',                        'parents': [{                            "id": folderID                        }]                        // "description": vm.currentTrack.metadata.desc                    };                    Drive.saveFile(metadata, gpx).then(function(files) {                        console.log("FileSave: success.");                        // window.alert("file uploaded");                    }, function() {                        console.log("FileSave: error.");                    });                    /** Export KML */                    name = vm.currentTrack.metadata.name + ".kml";                    metadata = {                        'title': name,                        'mimeType': 'application/vnd.google-earth.kml+xml',                        'parents': [{                            "id": folderID                        }]                        // "description": vm.currentTrack.metadata.desc                    };                    Drive.saveFile(metadata, kml).then(function(files) {                        console.log("FileSave: success.");                        //@todo change alert to popup or view element                        window.alert("File uploaded:\nMyDrive/TractNotes/" + vm.currentTrack.metadata.name);                    }, function() {                        console.log("FileSave: error.");                    });                    // create file                    // upload to drive                    // upload media to drive [images, audio, video]                }, function() {                    console.log("Track Folder: error.");                });            });        }        function exportTrackToDevice() {            //@TODO            console.log('Export to device not yet implemented.');        }        /**         * Go back a single state by history         * @memberof TrackViewController         * @function back         */        function back() {            $ionicHistory.goBack();        }        /**         * Update changes in track metadata         * Calls vm.back()         * @memberof TrackViewController         * @function updateMetadata         */        function updateMetadata() {            trackService.setCurrentTrack(vm.currentTrack);            trackService.setTrackMetadata(vm.input);            vm.input = angular.copy(trackViewService.getTrackView().metadata)            vm.currentTrack = trackService.getCurrentTrack();            vm.back();        }        /**         * Discard changes in track metadata         * Calls vm.back()         * @memberof TrackViewController         * @function discardChanges         */        function discardChanges() {            vm.back();        }    }})();</code></pre>        </article>        <!-- index.html -->        <!-- class files -->      </div>      <footer style="clear:both">        Documentation generated by        <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a>        using        <a href="https://github.com/allenhwkim/angular-jsdoc">Angular-JSDoc template</a>      </footer>    </div>    <!--%= prettyJson %-->    <script>      prettyPrint();      var lineNo = window.location.hash.match(/#line([0-9]+)$/);      lineNo && document.querySelector("ol li:nth-child("+(lineNo[1])+")").scrollIntoView();    </script>  </body></html>